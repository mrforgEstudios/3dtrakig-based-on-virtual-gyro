<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gyro to GLB Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/GLTFExporter.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; touch-action: manipulation; }
        .rec-active { animation: pulse-red 1s infinite; background-color: #dc2626 !important; }
        @keyframes pulse-red {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(220, 38, 38, 0.5); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-between min-h-screen p-6">

    <div class="w-full text-center py-4">
        <h1 class="text-3xl font-black tracking-tight text-blue-400">GYRO TRACK</h1>
        <p class="text-slate-400 text-xs uppercase tracking-widest mt-1">Export to Reconn 4D</p>
    </div>

    <!-- Визуальное превью -->
    <div id="canvas-container" class="relative w-full aspect-square max-w-sm bg-slate-900 rounded-3xl overflow-hidden border-2 border-slate-800 shadow-2xl">
        <div id="overlay" class="absolute inset-0 flex items-center justify-center text-slate-600 text-center p-8 pointer-events-none">
            Камера появится после активации датчиков
        </div>
    </div>

    <div id="ui-controls" class="w-full max-w-xs space-y-4 mb-8">
        <button id="startBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-5 rounded-2xl shadow-lg transition-all active:scale-95">
            1. Активировать Гироскоп
        </button>
        
        <button id="recordBtn" disabled class="w-full bg-slate-700 text-slate-400 font-bold py-5 rounded-2xl opacity-50 cursor-not-allowed transition-all">
            2. Начать запись
        </button>

        <button id="downloadBtn" class="hidden w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-5 rounded-2xl shadow-xl transition-all active:scale-95">
            3. Сохранить .GLB
        </button>
    </div>

    <div id="status-bar" class="w-full bg-slate-900 p-4 rounded-t-3xl border-t border-slate-800 text-center">
        <span id="status-text" class="text-sm text-slate-500 uppercase font-medium">Ожидание...</span>
    </div>

    <script>
        let scene, camera, renderer, phoneMesh;
        let isRecording = false;
        let recordedData = [];
        let startTime = 0;

        function initThree() {
            document.getElementById('overlay').style.display = 'none';
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            const container = document.getElementById('canvas-container');
            renderer.setSize(container.clientWidth, container.clientWidth);
            container.appendChild(renderer.domElement);

            const geometry = new THREE.BoxGeometry(1, 1.8, 0.15);
            const materials = [
                new THREE.MeshStandardMaterial({color: 0x1e293b}), // right
                new THREE.MeshStandardMaterial({color: 0x1e293b}), // left
                new THREE.MeshStandardMaterial({color: 0x1e293b}), // top
                new THREE.MeshStandardMaterial({color: 0x1e293b}), // bottom
                new THREE.MeshStandardMaterial({color: 0x3b82f6}), // front (экран)
                new THREE.MeshStandardMaterial({color: 0x0f172a})  // back
            ];
            phoneMesh = new THREE.Mesh(geometry, materials);
            scene.add(phoneMesh);

            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const direct = new THREE.DirectionalLight(0xffffff, 0.8);
            direct.position.set(5, 5, 5);
            scene.add(direct);

            camera.position.z = 3;
            renderLoop();
        }

        function renderLoop() {
            requestAnimationFrame(renderLoop);
            renderer.render(scene, camera);
        }

        const startBtn = document.getElementById('startBtn');
        const recordBtn = document.getElementById('recordBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusText = document.getElementById('status-text');

        startBtn.onclick = async () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission === 'granted') startTracking();
            } else {
                startTracking();
            }
        };

        function startTracking() {
            window.addEventListener('deviceorientation', (e) => {
                const alpha = e.alpha ? THREE.MathUtils.degToRad(e.alpha) : 0;
                const beta = e.beta ? THREE.MathUtils.degToRad(e.beta) : 0;
                const gamma = e.gamma ? THREE.MathUtils.degToRad(e.gamma) : 0;
                
                // Исправляем ориентацию для мобильных устройств
                if (phoneMesh) {
                    phoneMesh.rotation.set(beta, alpha, -gamma, 'YXZ');
                    if (isRecording) {
                        recordedData.push({
                            time: (performance.now() - startTime) / 1000,
                            q: phoneMesh.quaternion.clone()
                        });
                    }
                }
            });

            startBtn.classList.add('hidden');
            recordBtn.disabled = false;
            recordBtn.classList.replace('bg-slate-700', 'bg-red-600');
            recordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            statusText.innerText = "Готов к записи";
            initThree();
        }

        recordBtn.onclick = () => {
            if (!isRecording) {
                isRecording = true;
                recordedData = [];
                startTime = performance.now();
                recordBtn.innerText = "Остановить";
                recordBtn.classList.add('rec-active');
                downloadBtn.classList.add('hidden');
                statusText.innerText = "Запись...";
            } else {
                isRecording = false;
                recordBtn.innerText = "Начать заново";
                recordBtn.classList.remove('rec-active');
                downloadBtn.classList.remove('hidden');
                statusText.innerText = `Готово: ${recordedData.length} кадров`;
            }
        };

        downloadBtn.onclick = () => {
            statusText.innerText = "Генерация GLB...";
            
            const exportScene = new THREE.Scene();
            const trackCamera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            trackCamera.name = "GyroCamera"; // Reconn 4D увидит это имя
            exportScene.add(trackCamera);

            const times = recordedData.map(d => d.time);
            const values = [];
            recordedData.forEach(d => {
                values.push(d.q.x, d.q.y, d.q.z, d.q.w);
            });

            const track = new THREE.QuaternionKeyframeTrack('GyroCamera.quaternion', times, values);
            const clip = new THREE.AnimationClip('Action', -1, [track]);

            const exporter = new THREE.GLTFExporter();
            // Используем бинарный формат (binary: true), он надежнее для скачивания
            exporter.parse(exportScene, (result) => {
                const blob = new Blob([result], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `track_${Math.floor(Date.now()/1000)}.glb`;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    statusText.innerText = "Файл сохранен";
                }, 100);
                
            }, { binary: true, animations: [clip] });
        };
    </script>
</body>
</html>

